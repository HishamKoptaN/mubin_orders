name: Build APKs
on:
  push:
    branches:
      - main
jobs:
  build:
    if: contains(github.event.head_commit.message, 'build')
    runs-on: ubuntu-latest
    steps:
      #! 1. التحقق من الكود
      - name: التحقق من الكود
        uses: actions/checkout@v4
      #! 2. إعداد JDK
      - name: إعداد JDK
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'
      #! 3. إعداد فلاتر
      - name: إعداد فلاتر
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.0.0'
          channel: stable
          architecture: x64
          cache: false
          pub-cache-path: default
          dry-run: false
      - name: Upgrade Flutter
        run: flutter upgrade
      - name: فحص بيئة فلاتر
        run: flutter doctor  
      #! 4. تحميل التبعيات
      - name: تحميل التبعيات
        run: flutter pub get
      - name: تنظيف المشروع
        run: flutter clean
      #! 5. بناء نسخ الاندرويد
      - name: بناء نسخ الاندرويد
        run: flutter build apk --split-per-abi
      - name: التأكد من وجود ملفات APK
        run: |
          if [[ ! -f build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ]]; then
            echo "❌ فشل البناء! لم يتم العثور على ملفات APK"
            exit 1
          fi  
      #! 6. رفع النسخ كـ Artifacts
      - name: رفع النسخ كـ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: |
            build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            build/app/outputs/flutter-apk/app-x86_64-release.apk
      #! 7. رفع النسخ إلى GitHub Releases
      - name: رفع النسخ إلى GitHub Releases
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v1.0.40
          name: Flutter APK Release
          artifacts: |
            build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            build/app/outputs/flutter-apk/app-x86_64-release.apk
          allowUpdates: true
          skipIfReleaseExists: false
          generateReleaseNotes: false
          makeLatest: true
    